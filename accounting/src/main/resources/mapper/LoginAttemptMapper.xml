<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.family.accounting.mapper.LoginAttemptMapper">

    <resultMap id="BaseResultMap" type="com.family.accounting.entity.LoginAttempt">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="ip_address" property="ipAddress" jdbcType="VARCHAR"/>
        <result column="success" property="success" jdbcType="TINYINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <insert id="insert" parameterType="com.family.accounting.entity.LoginAttempt">
        INSERT INTO t_login_attempt (phone, ip_address, success, created_at)
        VALUES (#{phone}, #{ipAddress}, #{success}, #{createdAt})
    </insert>

    <select id="countFailedAttempts" resultType="int">
        SELECT COUNT(*)
        FROM t_login_attempt
        WHERE phone = #{phone}
          AND success = 0
          AND created_at >= #{startTime}
    </select>

    <select id="countRequestsByIp" resultType="int">
        SELECT COUNT(*)
        FROM t_login_attempt
        WHERE ip_address = #{ipAddress}
          AND created_at >= #{startTime}
    </select>

    <select id="findByPhone" resultMap="BaseResultMap">
        SELECT id, phone, ip_address, success, created_at
        FROM t_login_attempt
        WHERE phone = #{phone}
        ORDER BY created_at DESC
    </select>

    <select id="findByIpAddress" resultMap="BaseResultMap">
        SELECT id, phone, ip_address, success, created_at
        FROM t_login_attempt
        WHERE ip_address = #{ipAddress}
        ORDER BY created_at DESC
    </select>

    <select id="getLastFailedAttemptTime" resultType="java.time.LocalDateTime">
        SELECT created_at
        FROM t_login_attempt
        WHERE phone = #{phone}
          AND success = 0
        ORDER BY created_at DESC
        LIMIT 1
    </select>

</mapper>